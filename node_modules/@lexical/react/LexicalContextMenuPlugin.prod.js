/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

"use strict";var e=require("@lexical/react/LexicalComposerContext"),t=require("@lexical/utils"),n=require("lexical"),l=require("react"),o=require("react/jsx-runtime");function r(e){var t=Object.create(null);if(e)for(var n in e)t[n]=e[n];return t.default=e,t}var i=r(l);const u="undefined"!=typeof window&&void 0!==window.document&&void 0!==window.document.createElement,s=u?l.useLayoutEffect:l.useEffect;const c=e=>{const t=document.getElementById("typeahead-menu");if(!t)return;const n=t.getBoundingClientRect();n.top+n.height>window.innerHeight&&t.scrollIntoView({block:"center"}),n.top<0&&t.scrollIntoView({block:"center"}),e.scrollIntoView({block:"nearest"})};function a(e,t){const n=e.getBoundingClientRect(),l=t.getBoundingClientRect();return n.top>l.top&&n.top<l.bottom}function m(t,n,o,r){const[i]=e.useLexicalComposerContext();l.useEffect((()=>{if(null!=n&&null!=t){const e=i.getRootElement(),t=null!=e?function(e,t){let n=getComputedStyle(e);const l="absolute"===n.position,o=/(auto|scroll)/;if("fixed"===n.position)return document.body;for(let t=e;t=t.parentElement;)if(n=getComputedStyle(t),(!l||"static"!==n.position)&&o.test(n.overflow+n.overflowY+n.overflowX))return t;return document.body}(e):document.body;let l=!1,u=a(n,t);const s=function(){l||(window.requestAnimationFrame((function(){o(),l=!1})),l=!0);const e=a(n,t);e!==u&&(u=e,null!=r&&r(e))},c=new ResizeObserver(o);return window.addEventListener("resize",o),document.addEventListener("scroll",s,{capture:!0,passive:!0}),c.observe(n),()=>{c.unobserve(n),window.removeEventListener("resize",o),document.removeEventListener("scroll",s,!0)}}}),[n,i,r,o,t])}const d=n.createCommand("SCROLL_TYPEAHEAD_OPTION_INTO_VIEW_COMMAND");function f({close:e,editor:o,anchorElementRef:r,resolution:i,options:u,menuRenderFn:a,onSelectOption:m,shouldSplitNodeWithQuery:f=!1,commandPriority:p=n.COMMAND_PRIORITY_LOW}){const[g,h]=l.useState(null),C=i.match&&i.match.matchingString;l.useEffect((()=>{h(0)}),[C]);const E=l.useCallback((t=>{o.update((()=>{const l=null!=i.match&&f?function(e){const t=n.$getSelection();if(!n.$isRangeSelection(t)||!t.isCollapsed())return null;const l=t.anchor;if("text"!==l.type)return null;const o=l.getNode();if(!o.isSimpleText())return null;const r=l.offset,i=o.getTextContent().slice(0,r),u=e.replaceableString.length,s=r-function(e,t,n){let l=n;for(let n=l;n<=t.length;n++)e.slice(-n)===t.substring(0,n)&&(l=n);return l}(i,e.matchingString,u);if(s<0)return null;let c;return 0===s?[c]=o.splitText(r):[,c]=o.splitText(s,r),c}(i.match):null;m(t,l,e,i.match?i.match.matchingString:"")}))}),[o,f,i.match,m,e]),v=l.useCallback((e=>{const t=o.getRootElement();null!==t&&(t.setAttribute("aria-activedescendant","typeahead-item-"+e),h(e))}),[o]);l.useEffect((()=>()=>{const e=o.getRootElement();null!==e&&e.removeAttribute("aria-activedescendant")}),[o]),s((()=>{null===u?h(null):null===g&&v(0)}),[u,g,v]),l.useEffect((()=>t.mergeRegister(o.registerCommand(d,(({option:e})=>!(!e.ref||null==e.ref.current)&&(c(e.ref.current),!0)),p))),[o,v,p]),l.useEffect((()=>t.mergeRegister(o.registerCommand(n.KEY_ARROW_DOWN_COMMAND,(e=>{const t=e;if(null!==u&&u.length&&null!==g){const e=g!==u.length-1?g+1:0;v(e);const n=u[e];null!=n.ref&&n.ref.current&&o.dispatchCommand(d,{index:e,option:n}),t.preventDefault(),t.stopImmediatePropagation()}return!0}),p),o.registerCommand(n.KEY_ARROW_UP_COMMAND,(e=>{const t=e;if(null!==u&&u.length&&null!==g){const e=0!==g?g-1:u.length-1;v(e);const n=u[e];null!=n.ref&&n.ref.current&&c(n.ref.current),t.preventDefault(),t.stopImmediatePropagation()}return!0}),p),o.registerCommand(n.KEY_ESCAPE_COMMAND,(t=>{const n=t;return n.preventDefault(),n.stopImmediatePropagation(),e(),!0}),p),o.registerCommand(n.KEY_TAB_COMMAND,(e=>{const t=e;return null!==u&&null!==g&&null!=u[g]&&(t.preventDefault(),t.stopImmediatePropagation(),E(u[g]),!0)}),p),o.registerCommand(n.KEY_ENTER_COMMAND,(e=>null!==u&&null!==g&&null!=u[g]&&(null!==e&&(e.preventDefault(),e.stopImmediatePropagation()),E(u[g]),!0)),p))),[E,e,o,u,g,v,p]);return a(r,l.useMemo((()=>({options:u,selectOptionAndCleanUp:E,selectedIndex:g,setHighlightedIndex:h})),[E,g,u]),i.match?i.match.matchingString:"")}exports.LexicalContextMenuPlugin=function({options:r,onWillOpen:s,onClose:c,onOpen:a,onSelectOption:d,menuRenderFn:p,anchorClassName:g,commandPriority:h=n.COMMAND_PRIORITY_LOW,parent:C}){const[E]=e.useLexicalComposerContext(),[v,R]=l.useState(null),b=i.useRef(null),w=function(t,n,o,r=(u?document.body:void 0),i=!0){const[s]=e.useLexicalComposerContext(),c=l.useRef(u?document.createElement("div"):null),a=l.useCallback((()=>{if(null===c.current||void 0===r)return;c.current.style.top=c.current.style.bottom;const e=s.getRootElement(),n=c.current,l=n.firstChild;if(null!==e&&null!==t){const{left:u,top:s,width:a,height:m}=t.getRect(),d=c.current.offsetHeight;if(n.style.top=`${s+d+3+(i?window.pageYOffset:0)}px`,n.style.left=`${u+window.pageXOffset}px`,n.style.height=`${m}px`,n.style.width=`${a}px`,null!==l){l.style.top=`${s}`;const t=l.getBoundingClientRect(),o=t.height,r=t.width,c=e.getBoundingClientRect();u+r>c.right&&(n.style.left=`${c.right-r+window.pageXOffset}px`),(s+o>window.innerHeight||s+o>c.bottom)&&s-c.top>o+m&&(n.style.top=`${s-o-m+(i?window.pageYOffset:0)}px`)}n.isConnected||(null!=o&&(n.className=o),n.setAttribute("aria-label","Typeahead menu"),n.setAttribute("id","typeahead-menu"),n.setAttribute("role","listbox"),n.style.display="block",n.style.position="absolute",r.append(n)),c.current=n,e.setAttribute("aria-controls","typeahead-menu")}}),[s,t,i,o,r]);l.useEffect((()=>{const e=s.getRootElement();if(null!==t)return a(),()=>{null!==e&&e.removeAttribute("aria-controls");const t=c.current;null!==t&&t.isConnected&&t.remove()}}),[s,a,t]);const d=l.useCallback((e=>{null!==t&&(e||n(null))}),[t,n]);m(t,c.current,a,d);const f=c.current;return null!=f&&(f.style.position="absolute",null!=r&&r.append(f)),c}(v,R,g,C),x=l.useCallback((()=>{R(null),null!=c&&null!==v&&c()}),[c,v]),O=l.useCallback((e=>{R(e),null!=a&&null===v&&a(e)}),[a,v]),y=l.useCallback((e=>{e.preventDefault(),null!=s&&s(e);const n=t.calculateZoomLevel(e.target);O({getRect:()=>new DOMRect(e.clientX/n,e.clientY/n,1,1)})}),[O,s]),A=l.useCallback((e=>{null!==v&&null!=b.current&&null!=e.target&&n.isDOMNode(e.target)&&!b.current.contains(e.target)&&x()}),[x,v]);return l.useEffect((()=>{const e=E.getRootElement();if(e)return e.addEventListener("contextmenu",y),()=>e.removeEventListener("contextmenu",y)}),[E,y]),l.useEffect((()=>(document.addEventListener("click",A),()=>document.removeEventListener("click",A))),[E,A]),null===w.current||null===v||null===E?null:o.jsx(f,{close:x,resolution:v,editor:E,anchorElementRef:w,options:r,menuRenderFn:(e,t)=>p(e,t,{setMenuRef:e=>{b.current=e}}),onSelectOption:d,commandPriority:h})},exports.MenuOption=class{constructor(e){this.key=e,this.ref={current:null},this.setRefElement=this.setRefElement.bind(this)}setRefElement(e){this.ref={current:e}}};
