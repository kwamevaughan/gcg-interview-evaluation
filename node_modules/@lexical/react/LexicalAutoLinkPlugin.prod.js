/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

"use strict";var e=require("@lexical/link"),t=require("@lexical/react/LexicalComposerContext"),n=require("@lexical/utils"),i=require("lexical"),r=require("react");function o(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var l=o((function(e){const t=new URL("https://lexical.dev/docs/error"),n=new URLSearchParams;n.append("code",e);for(let e=1;e<arguments.length;e++)n.append("v",arguments[e]);throw t.search=n.toString(),Error(`Minified Lexical error #${e}; visit ${t.toString()} for the full message or use the non-minified dev environment for full errors and additional helpful warnings.`)}));function s(e,t){for(let n=0;n<t.length;n++){const i=t[n](e);if(i)return i}return null}const u=/[.,;\s]/;function c(e){return u.test(e)}function g(e){return c(e[e.length-1])}function a(e){return c(e[0])}function f(e){let t=e.getPreviousSibling();return i.$isElementNode(t)&&(t=t.getLastDescendant()),null===t||i.$isLineBreakNode(t)||i.$isTextNode(t)&&g(t.getTextContent())}function d(e){let t=e.getNextSibling();return i.$isElementNode(t)&&(t=t.getFirstDescendant()),null===t||i.$isLineBreakNode(t)||i.$isTextNode(t)&&a(t.getTextContent())}function x(e,t,n,i){if(!(e>0?c(n[e-1]):f(i[0])))return!1;return t<n.length?c(n[t]):d(i[i.length-1])}function h(e,t,n){const i=[],r=[],o=[];let l=0,s=0;const u=[...e];for(;u.length>0;){const e=u[0],c=e.getTextContent().length,g=s;s+c<=t?(i.push(e),l+=c):g>=n?o.push(e):r.push(e),s+=c,u.shift()}return[l,i,r,o]}function p(t,n,r,o){const l=e.$createAutoLinkNode(o.url,o.attributes);if(1===t.length){let e,s=t[0];0===n?[e,s]=s.splitText(r):[,e,s]=s.splitText(n,r);const u=i.$createTextNode(o.text);return u.setFormat(e.getFormat()),u.setDetail(e.getDetail()),u.setStyle(e.getStyle()),l.append(u),e.replace(l),s}if(t.length>1){const e=t[0];let o,s=e.getTextContent().length;0===n?o=e:[,o]=e.splitText(n);const u=[];let c;for(let e=1;e<t.length;e++){const n=t[e],i=n.getTextContent().length,o=s;if(o<r)if(s+i<=r)u.push(n);else{const[e,t]=n.splitText(r-o);u.push(e),c=t}s+=i}const g=i.$getSelection(),a=g?g.getNodes().find(i.$isTextNode):void 0,f=i.$createTextNode(o.getTextContent());return f.setFormat(o.getFormat()),f.setDetail(o.getDetail()),f.setStyle(o.getStyle()),l.append(f,...u),a&&a===o&&(i.$isRangeSelection(g)?f.select(g.anchor.offset,g.focus.offset):i.$isNodeSelection(g)&&f.select(0,f.getTextContent().length)),o.replace(l),c}}function T(e,t,n){const r=e.getChildren(),o=r.length;for(let t=0;t<o;t++){const o=r[t];if(!i.$isTextNode(o)||!o.isSimpleText())return N(e),void n(null,e.getURL())}const l=e.getTextContent(),u=s(l,t);if(null===u||u.text!==l)return N(e),void n(null,e.getURL());if(!f(e)||!d(e))return N(e),void n(null,e.getURL());const c=e.getURL();if(c!==u.url&&(e.setURL(u.url),n(u.url,c)),u.attributes){const t=e.getRel();t!==u.attributes.rel&&(e.setRel(u.attributes.rel||null),n(u.attributes.rel||null,t));const i=e.getTarget();i!==u.attributes.target&&(e.setTarget(u.attributes.target||null),n(u.attributes.target||null,i))}}function N(e){const t=e.getChildren();for(let n=t.length-1;n>=0;n--)e.insertAfter(t[n]);return e.remove(),t.map((e=>e.getLatest()))}function L(t,o,u){r.useEffect((()=>{t.hasNodes([e.AutoLinkNode])||l(77);const r=(e,t)=>{u&&u(e,t)};return n.mergeRegister(t.registerNodeTransform(i.TextNode,(t=>{const n=t.getParentOrThrow(),l=t.getPreviousSibling();if(e.$isAutoLinkNode(n)&&!n.getIsUnlinked())T(n,o,r);else if(!e.$isLinkNode(n)){if(t.isSimpleText()&&(a(t.getTextContent())||!e.$isAutoLinkNode(l))){const e=function(e){const t=[e];let n=e.getNextSibling();for(;null!==n&&i.$isTextNode(n)&&n.isSimpleText()&&(t.push(n),!/[\s]/.test(n.getTextContent()));)n=n.getNextSibling();return t}(t);!function(e,t,n){let i=[...e];const r=i.map((e=>e.getTextContent())).join("");let o,l=r,u=0;for(;(o=s(l,t))&&null!==o;){const e=o.index,t=e+o.length;if(x(u+e,u+t,r,i)){const[r,,l,s]=h(i,u+e,u+t),c=p(l,u+e-r,u+t-r,o);i=c?[c,...s]:s,n(o.url,null),u=0}else u+=t;l=l.substring(t)}}(e,o,r)}!function(t,n,i){const r=t.getPreviousSibling(),o=t.getNextSibling(),l=t.getTextContent();var s;!e.$isAutoLinkNode(r)||r.getIsUnlinked()||a(l)&&(s=l,!(r.isEmailURI()?/^\.[a-zA-Z]{2,}/.test(s):/^\.[a-zA-Z0-9]{1,}/.test(s)))||(r.append(t),T(r,n,i),i(null,r.getURL())),!e.$isAutoLinkNode(o)||o.getIsUnlinked()||g(l)||(N(o),T(o,n,i),i(null,o.getURL()))}(t,o,r)}})),t.registerCommand(e.TOGGLE_LINK_COMMAND,(t=>{const n=i.$getSelection();if(null!==t||!i.$isRangeSelection(n))return!1;return n.extract().forEach((t=>{const n=t.getParent();if(e.$isAutoLinkNode(n))return n.setIsUnlinked(!n.getIsUnlinked()),n.markDirty(),!0})),!1}),i.COMMAND_PRIORITY_LOW))}),[t,o,u])}exports.AutoLinkPlugin=function({matchers:e,onChange:n}){const[i]=t.useLexicalComposerContext();return L(i,e,n),null},exports.createLinkMatcherWithRegExp=function(e,t=(e=>e)){return n=>{const i=e.exec(n);return null===i?null:{index:i.index,length:i[0].length,text:i[0],url:t(i[0])}}};
